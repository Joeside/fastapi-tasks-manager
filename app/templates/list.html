{% extends "base.html" %}
{% block title %}Liste des t√¢ches{% endblock %}

{% block content %}
<h1 class="text-xl font-bold mb-3">Liste des t√¢ches</h1>

<!-- Formulaire d'ajout -->
<div class="card mb-8">
  <div class="text-sm font-semibold mb-4">Ajouter une t√¢che</div>

  <form method="post" action="/list/add" class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
    <div class="flex flex-col">
      <label class="font-medium mb-1">Titre *</label>
      <input type="text" name="title" required placeholder="Ex: Pr√©parer la r√©union de lundi" />
    </div>

    <div class="flex flex-col md:col-span-2">
      <label class="font-medium mb-1">Description</label>
      <textarea name="description" rows="2" placeholder="Notes, contexte, d√©tails‚Ä¶"></textarea>
    </div>

    <div class="flex flex-col">
      <label class="font-medium mb-1">√âch√©ance</label>
      <input type="date" name="due_date" />
    </div>

    <div class="flex flex-col">
      <label class="font-medium mb-1">Tag</label>
      <input type="text" name="tag" placeholder="Ex: boulot, perso" />
    </div>

    <div class="flex flex-col gap-2">
      <label class="font-medium mb-1">Priorisation</label>

      <div class="flex gap-4">
        <label class="checkbox-wrapper">
          <input type="checkbox" name="urgent" />
          <span>Urgent</span>
        </label>

        <label class="checkbox-wrapper">
          <input type="checkbox" name="important" />
          <span>Important</span>
        </label>
      </div>
    </div>

    <div class="flex flex-col">
      <label class="font-medium mb-1">R√©currence</label>
      <select name="recurrence_pattern">
        <option value="">Aucune</option>
        <option value="daily">Quotidienne</option>
        <option value="weekly">Hebdomadaire</option>
        <option value="monthly">Mensuelle</option>
      </select>
    </div>

    <div class="flex flex-col">
      <label class="font-medium mb-1">Jusqu'au</label>
      <input type="date" name="recurrence_end_date" />
    </div>


    <div class="md:col-span-2 flex gap-3 items-center">
      <button class="btn btn-primary" type="submit">
        Ajouter
      </button>
    </div>
  </form>
</div>

<!-- Barre de filtres & tri (sans A/B/C) -->
<div class="card mb-4">
  <form method="get" class="grid grid-cols-1 md:grid-cols-6 gap-3 text-sm">
    <!-- Statut -->
    <div class="flex flex-col">
      <label class="font-medium mb-1">Statut</label>
      <select name="status_f">
        <option value="all" {{ 'selected' if status_f=='all' else '' }}>Tous</option>
        <option value="todo" {{ 'selected' if status_f=='todo' else '' }}>√Ä faire</option>
        <option value="done" {{ 'selected' if status_f=='done' else '' }}>Fait</option>
      </select>
    </div>

    <!-- Urgent -->
    <div class="flex flex-col">
      <label class="font-medium mb-1">Urgent</label>
      <select name="urgent_f">
        <option value="all" {{ 'selected' if urgent_f=='all' else '' }}>Tous</option>
        <option value="yes" {{ 'selected' if urgent_f=='yes' else '' }}>Oui</option>
        <option value="no" {{ 'selected' if urgent_f=='no' else '' }}>Non</option>
      </select>
    </div>

    <!-- Important -->
    <div class="flex flex-col">
      <label class="font-medium mb-1">Important</label>
      <select name="important_f">
        <option value="all" {{ 'selected' if important_f=='all' else '' }}>Tous</option>
        <option value="yes" {{ 'selected' if important_f=='yes' else '' }}>Oui</option>
        <option value="no" {{ 'selected' if important_f=='no' else '' }}>Non</option>
      </select>
    </div>

    <!-- Recherche texte -->
    <div class="flex flex-col md:col-span-2">
      <label class="font-medium mb-1">Recherche</label>
      <input type="text" name="q" value="{{ q }}" placeholder="Titre ou description" />
    </div>

    <!-- Tri -->
    <div class="flex flex-col md:col-span-2">
      <label class="font-medium mb-1">Trier par</label>
      <select name="sort">
        <option value="created_desc" {{ 'selected' if sort=='created_desc' else '' }}>Cr√©ation (r√©cent ‚Üí ancien)
        </option>
        <option value="due_asc" {{ 'selected' if sort=='due_asc' else '' }}>√âch√©ance (proche ‚Üí loin)</option>
        <option value="due_desc" {{ 'selected' if sort=='due_desc' else '' }}>√âch√©ance (loin ‚Üí proche)</option>
        <option value="position" {{ 'selected' if sort=='position' else '' }}>Position (ordre manuel)</option>
      </select>
    </div>

    <!-- Actions -->
    <div class="md:col-span-4 flex items-end gap-3">
      <button class="btn btn-primary" type="submit">Appliquer</button>
      <a class="btn btn-secondary" href="/list">R√©initialiser</a>
      <span class="text-xs text-slate-500">
        {{ tasks|length }} t√¢che(s) affich√©e(s) sur {{ total_count }}.
      </span>
    </div>
  </form>
</div>

<!-- Filtres actifs (sans priorit√©) -->
{% if has_filters %}
<div class="mb-4 text-sm">
  <div class="flex items-center flex-wrap gap-2">
    <span class="text-slate-500">Filtres actifs :</span>

    {% if status_f != 'all' %}
    <a class="chip" href="{{ urls_clear['status_f'] }}">
      Statut :
      {% if status_f == 'todo' %} √Ä faire {% elif status_f == 'done' %} Fait {% else %} {{ status_f }} {% endif %}
      <span class="chip-x">√ó</span>
    </a>
    {% endif %}

    {% if urgent_f != 'all' %}
    <a class="chip" href="{{ urls_clear['urgent_f'] }}">
      Urgent : {% if urgent_f == 'yes' %} Oui {% else %} Non {% endif %}
      <span class="chip-x">√ó</span>
    </a>
    {% endif %}

    {% if important_f != 'all' %}
    <a class="chip" href="{{ urls_clear['important_f'] }}">
      Important : {% if important_f == 'yes' %} Oui {% else %} Non {% endif %}
      <span class="chip-x">√ó</span>
    </a>
    {% endif %}

    {% if q %}
    <a class="chip" href="{{ urls_clear['q'] }}">
      Recherche : ‚Äú{{ q }}‚Äù
      <span class="chip-x">√ó</span>
    </a>
    {% endif %}
    <a class="chip chip-clear" href="{{ urls_clear['all'] }}">Tout effacer</a>
  </div>
</div>
{% endif %}

<!-- Tableau -->
<div class="card card-table overflow-hidden">
  <table class="table text-sm">
    <thead>
      <tr>
        <th>Titre</th>
        <th>Priorit√©</th>
        <th>Action</th>
        <th>√âch√©ance</th>
        <th>Statut</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody>
      {% if tasks|length == 0 %}
      <tr>
        <td colspan="6" class="py-4 text-center text-slate-400">
          Aucune t√¢che √† afficher.
        </td>
      </tr>
      {% else %}
      {% for section in due_sections %}
      {# Sections par √©ch√©ance (t√¢ches √† faire uniquement) #}
      {% if section.tasks|length %}
      <!-- Ligne de section -->
      <tr class="section-row">
        <td colspan="6" class="py-2 px-3 font-semibold text-xs uppercase tracking-wide text-slate-500">
          {{ section.label }}
        </td>
      </tr>

      {% for t in section.tasks %}
      <tr data-task-id="{{ t.id }}"
        class="{% if t.quadrant == 1 and t.due_status == 'overdue' %}row-critical{% endif %}">
        <!-- Titre + badge d‚Äô√©ch√©ance + etc. (ta version actuelle) -->
        <td>
          <div class="title-row">
            <span class="drag-handle" title="D√©placer">‚ò∞</span>
            <span class="title-text">{{ t.title }}</span>

            {% if t.due_status == 'overdue' %}
            <span class="badge badge-due-overdue" title="En retard">Retard</span>
            {% elif t.due_status == 'today' %}
            <span class="badge badge-due-today" title="√âch√©ance aujourd'hui">Auj.</span>
            {% elif t.due_status == 'soon' %}
            <span class="badge badge-due-soon" title="√âch√©ance cette semaine">7 j</span>
            {% endif %}
          </div>

          {% if t.description %}
          <div class="text-xs text-slate-500 mt-1">{{ t.description }}</div>
          {% endif %}
          {% if t.tag %}
          <div class="text-xs text-slate-400 mt-1">Tag: <span class="font-medium">{{ t.tag }}</span></div>
          {% endif %}
        </td>

        <td class="text-center">

          {% if t.urgent %}
          <span class="prio-icon prio-urgent" title="Urgent">üî•</span>
          {% endif %}

          {% if t.important %}
          <span class="prio-icon prio-important" title="Important">‚≠ê</span>
          {% endif %}

          {% if not t.urgent and not t.important %}
          <span class="prio-none">‚Ä¢</span>
          {% endif %}

        </td>

        <td>
          {% if t.quadrant == 1 %}
          <span class="badge badge-quadrant badge-q1">Faire</span>
          {% elif t.quadrant == 2 %}
          <span class="badge badge-quadrant badge-q2">Planifier</span>
          {% elif t.quadrant == 3 %}
          <span class="badge badge-quadrant badge-q3">D√©l√©guer</span>
          {% else %}
          <span class="badge badge-quadrant badge-q4">√âliminer</span>
          {% endif %}
        </td>

        <td>
          {% if t.due_date %}
          <span class="inline-flex items-center gap-1">
            <span class="text-xs">üìÖ</span>
            <span>{{ t.due_date }}</span>
          </span>
          {% else %}
          <span class="text-slate-400 text-xs">‚Äì</span>
          {% endif %}
        </td>

        <td>
          {% if t.status == "done" %}
          <span class="badge badge-done">Fait</span>
          {% else %}
          <span class="badge badge-todo">√Ä faire</span>
          {% endif %}
        </td>

        <td class="space-y-1">
          <a href="/list/edit/{{ t.id }}" class="btn btn-secondary btn-sm w-full">
            Modifier
          </a>

          {% if t.status != "done" %}
          <form method="post" action="/list/complete/{{ t.id }}">
            <button class="btn btn-primary btn-sm w-full">Terminer</button>
          </form>
          {% else %}
          <form method="post" action="/list/reopen/{{ t.id }}">
            <button class="btn btn-secondary btn-sm w-full">R√©tablir</button>
          </form>
          {% endif %}
        </td>

      </tr>
      {% endfor %}
      {% endif %}
      {% endfor %}

      {# Nouvelle section : t√¢ches termin√©es #}
      {% if done_tasks|length %}
      <tr class="section-row">
        <td colspan="6" class="py-2 px-3 font-semibold text-xs uppercase tracking-wide text-slate-500">
          T√¢ches termin√©es
        </td>
      </tr>

      {% for t in done_tasks %}
      <tr data-task-id="{{ t.id }}">
        <td>
          <div class="font-medium flex items-center gap-2">
            {{ t.title }}
          </div>
          {% if t.description %}
          <div class="text-xs text-slate-500 mt-1">{{ t.description }}</div>
          {% endif %}
          {% if t.tag %}
          <div class="text-xs text-slate-400 mt-1">Tag: <span class="font-medium">{{ t.tag }}</span></div>
          {% endif %}
        </td>

        <td class="text-center">
          {% if t.urgent %}
          <span class="prio-icon prio-urgent" title="Urgent">üî•</span>
          {% endif %}
          {% if t.important %}
          <span class="prio-icon prio-important" title="Important">‚≠ê</span>
          {% endif %}
          {% if not t.urgent and not t.important %}
          <span class="prio-none">‚Ä¢</span>
          {% endif %}
        </td>

        <td>
          {% if t.quadrant == 1 %}
          <span class="badge badge-quadrant badge-q1">Q1 ‚Äì Faire</span>
          {% elif t.quadrant == 2 %}
          <span class="badge badge-quadrant badge-q2">Q2 ‚Äì Planifier</span>
          {% elif t.quadrant == 3 %}
          <span class="badge badge-quadrant badge-q3">Q3 ‚Äì D√©l√©guer</span>
          {% else %}
          <span class="badge badge-quadrant badge-q4">Q4 ‚Äì √âliminer</span>
          {% endif %}
        </td>

        <td>
          {% if t.due_date %}
          <span class="inline-flex items-center gap-1">
            <span class="text-xs">üìÖ</span>
            <span>{{ t.due_date }}</span>
          </span>
          {% else %}
          <span class="text-slate-400 text-xs">‚Äì</span>
          {% endif %}
        </td>

        <td>
          <span class="badge badge-done">Fait</span>
        </td>

        <td>
          <form method="post" action="/list/reopen/{{ t.id }}">
            <button class="btn btn-secondary btn-sm w-full">R√©tablir</button>
          </form>
        </td>
      </tr>
      {% endfor %}
      {% endif %}
      {% endif %}
    </tbody>
  </table>
</div>


{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<style>
  /* show move cursor and hint that rows are draggable */
  .card-table table tbody tr:not(.section-row) {
    cursor: grab;
    -webkit-user-select: none;
    -ms-user-select: none;
    user-select: none;
  }

  .card-table table tbody tr:not(.section-row):active {
    cursor: grabbing;
  }
</style>
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const tbody = document.querySelector('.card-table table tbody');
    if (!tbody || typeof Sortable === 'undefined') return;

    Sortable.create(tbody, {
      onStart: function () { document.body.style.userSelect = 'none'; },
      draggable: 'tr:not(.section-row)',
      handle: '.drag-handle',
      animation: 150,
      onEnd: async function () {
        // re-enable text selection
        document.body.style.userSelect = '';
        // Collect visible task rows (exclude section headers) and send bulk reorder
        const rows = Array.from(tbody.querySelectorAll('tr')).filter(r => !r.classList.contains('section-row'));
        const items = [];
        let pos = 1;
        for (const row of rows) {
          const id = row.dataset.taskId;
          if (!id) continue;
          items.push({ id: Number(id), position: pos });
          pos++;
        }

        try {
          await fetch('/api/tasks/reorder', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ items }),
          });
        } catch (err) {
          console.error('Failed to bulk update positions', err);
        }
      },
    });
  });
</script>
{% endblock %}
