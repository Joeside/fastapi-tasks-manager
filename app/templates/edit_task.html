{% extends "base.html" %}

{% block content %}
<div class="page">
    <h1 class="text-xl font-bold mb-3">Modifier la t√¢che</h1>

    <div class="card edit-card">
        <form method="post" action="/list/edit/{{ task.id }}" class="space-y-6">

            <!-- Titre -->
            <div class="edit-row">
                <label class="form-label edit-row-label" for="title">Titre</label>
                <div class="edit-row-field">
                    <input id="title" type="text" name="title" value="{{ task.title }}" required>
                </div>
            </div>

            <!-- Description -->
            <div class="edit-row">
                <label class="form-label edit-row-label" for="description">Description</label>
                <div class="edit-row-field">
                    <textarea id="description" name="description" rows="3">{{ task.description or '' }}</textarea>
                </div>
            </div>

            <!-- √âch√©ance -->
            <div class="edit-row">
                <label class="form-label edit-row-label" for="due_date">√âch√©ance</label>
                <div class="edit-row-field">
                    <input id="due_date" type="date" name="due_date" value="{{ task.due_date or '' }}">
                </div>
            </div>

            <!-- R√©currence -->
            <div class="edit-row">
                <label class="form-label edit-row-label" for="recurrence_pattern">R√©currence</label>
                <div class="edit-row-field flex gap-4 items-center">
                    <select id="recurrence_pattern" name="recurrence_pattern">
                        <option value="" {% if not task.recurrence_pattern %}selected{% endif %}>Aucune</option>
                        <option value="daily" {% if task.recurrence_pattern=='daily' %}selected{% endif %}>Quotidienne
                        </option>
                        <option value="weekly" {% if task.recurrence_pattern=='weekly' %}selected{% endif %}>
                            Hebdomadaire</option>
                        <option value="monthly" {% if task.recurrence_pattern=='monthly' %}selected{% endif %}>Mensuelle
                        </option>
                        <option value="yearly" {% if task.recurrence_pattern=='yearly' %}selected{% endif %}>Annuelle
                        </option>
                    </select>
                    <div>
                        <label for="recurrence_end_date" class="mr-2">Jusqu'au</label>
                        <input id="recurrence_end_date" type="date" name="recurrence_end_date"
                            value="{{ task.recurrence_end_date or '' }}">
                    </div>
                </div>
            </div>

            <!-- Tag -->
            <div class="edit-row">
                <label class="form-label edit-row-label" for="tag">Tag</label>
                <div class="edit-row-field">
                    <input id="tag" type="text" name="tag" value="{{ task.tag or '' }}" placeholder="Ex: boulot, perso">
                </div>
            </div>

            <!-- Priorisation -->
            <div class="edit-row">
                <span class="form-label edit-row-label">Priorisation</span>
                <div class="edit-row-field">
                    <div class="flex gap-4">
                        <label class="checkbox-wrapper">
                            <input type="checkbox" name="urgent" {% if task.urgent %}checked{% endif %}>
                            <span>Urgent üî•</span>
                        </label>
                        <label class="checkbox-wrapper">
                            <input type="checkbox" name="important" {% if task.important %}checked{% endif %}>
                            <span>Important ‚≠ê</span>
                        </label>
                    </div>
                </div>
            </div>

            <!-- Actions -->
            <div class="edit-actions">
                <a href="/list" class="btn btn-secondary">Annuler</a>
                <button type="submit" class="btn btn-primary">
                    Enregistrer
                </button>
            </div>
        </form>
    </div>

    <!-- Sous-t√¢ches -->
    <div class="card mt-6" data-task-id="{{ task.id }}">
        <h2 class="text-lg font-semibold mb-3">Sous-t√¢ches</h2>
        <form id="add-subtask-form" class="flex gap-2 mb-4">
            <input id="new-subtask-title" type="text" placeholder="Ajouter une sous-t√¢che" class="flex-1" />
            <button class="btn btn-primary" type="submit">Ajouter</button>
        </form>

        <ul id="subtasks-list" class="space-y-2">
            {% for s in subtasks %}
            <li class="flex items-center gap-3">
                <input type="checkbox" data-subtask-id="{{ s.id }}" {% if s.status=='done' %}checked{% endif %} />
                <span class="flex-1 {% if s.status=='done' %}line-through opacity-60{% endif %}">{{ s.title }}</span>
                <button class="text-red-600 text-sm" data-delete-subtask="{{ s.id }}">Supprimer</button>
            </li>
            {% else %}
            <li class="text-sm text-slate-500">Aucune sous-t√¢che.</li>
            {% endfor %}
        </ul>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    (function () {
        var subtasksCard = document.querySelector('[data-task-id]');
        var taskId = subtasksCard ? subtasksCard.getAttribute('data-task-id') : null;
        var addForm = document.getElementById('add-subtask-form');
        var addInput = document.getElementById('new-subtask-title');
        var listEl = document.getElementById('subtasks-list');

        if (addForm) {
            addForm.addEventListener('submit', async function (e) {
                e.preventDefault();
                var title = (addInput.value || '').trim();
                if (!title) return;
                var res = await fetch('/api/tasks/' + taskId + '/subtasks/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ title: title, status: 'todo' })
                });
                if (res.ok) {
                    location.reload();
                }
            });
        }

        if (listEl) {
            listEl.addEventListener('change', async function (e) {
                var t = e.target;
                if (t && t.matches('input[type="checkbox"][data-subtask-id]')) {
                    var sid = t.getAttribute('data-subtask-id');
                    var status = t.checked ? 'done' : 'todo';
                    await fetch('/api/tasks/' + taskId + '/subtasks/' + sid, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ status: status })
                    });
                }
            });

            listEl.addEventListener('click', async function (e) {
                var btn = e.target.closest('[data-delete-subtask]');
                if (!btn) return;
                var sid = btn.getAttribute('data-delete-subtask');
                var res = await fetch('/api/tasks/' + taskId + '/subtasks/' + sid, { method: 'DELETE' });
                if (res.ok) {
                    location.reload();
                }
            });
        }
    })();
</script>
{% endblock %}
