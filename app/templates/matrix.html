{% extends "base.html" %}
{% block title %}Matrice d'Eisenhower{% endblock %}

{% block content %}
<h1 class="text-xl font-bold mb-3">Matrice d'Eisenhower</h1>

<div class="grid grid-cols-1 md:grid-cols-2 gap-6">
	<div class="card">
		<div class="font-semibold mb-2">Q1 ‚Äì √Ä faire</div>
		{% if q1|length == 0 %}
		<div class="text-xs text-slate-400">Rien pour l‚Äôinstant.</div>
		{% else %}
		<ul class="space-y-2 text-sm">
			{% for t in q1 %}
			<li data-task-id="{{ t.id }}" class="border-b border-slate-200/40 pb-2 last:border-b-0">
				<span class="drag-handle" title="D√©placer">‚ò∞</span>
				<!-- Ligne titre + ic√¥nes de priorit√© + badge d'√©ch√©ance align√© √† droite -->
				<div class="title-row">
					<!-- Gauche : titre + üî•‚≠ê -->
					<div class="title-text font-medium flex items-center gap-2">
						{{ t.title }}
						<span class="flex items-center gap-1">
							{% if t.urgent %}
							<span class="prio-icon prio-urgent" title="Urgent">üî•</span>
							{% endif %}
							{% if t.important %}
							<span class="prio-icon prio-important" title="Important">‚≠ê</span>
							{% endif %}
							{% if not t.urgent and not t.important %}
							<span class="prio-none">‚Ä¢</span>
							{% endif %}
						</span>
					</div>

					<!-- Droite : badge d'√©ch√©ance -->
					<div class="flex items-center gap-1">
						{% if t.due_status == 'overdue' %}
						<span class="badge badge-due-overdue" title="En retard">Retard</span>
						{% elif t.due_status == 'today' %}
						<span class="badge badge-due-today" title="√âch√©ance aujourd'hui">Auj.</span>
						{% elif t.due_status == 'soon' %}
						<span class="badge badge-due-soon" title="√âch√©ance cette semaine">7 j</span>
						{% endif %}
					</div>
				</div>

				<!-- Ligne infos : date + statut -->
				<div class="text-xs text-slate-500 flex items-center gap-2 mt-1">
					{% if t.due_date %}
					<span class="inline-flex items-center gap-1">
						<span>üìÖ</span> <span>{{ t.due_date }}</span>
					</span>
					{% else %}
					<span>Sans √©ch√©ance</span>
					{% endif %}
					{% if t.status == "done" %}
					<span class="badge badge-done">Fait</span>
					{% endif %}
				</div>

				{% if t.tag %}
				<div class="text-xs text-slate-400 mt-1">Tag: <span class="font-medium">{{ t.tag }}</span></div>
				{% endif %}
			</li>
			{% endfor %}
		</ul>
		{% endif %}
	</div>

	<div class="card">
		<div class="font-semibold mb-2">Q2 ‚Äì Planifier</div>
		{% if q2|length == 0 %}
		<div class="text-xs text-slate-400">Rien pour l‚Äôinstant.</div>
		{% else %}
		<ul class="space-y-2 text-sm">
			{% for t in q2 %}
			<li data-task-id="{{ t.id }}" class="border-b border-slate-200/40 pb-2 last:border-b-0">
				<span class="drag-handle" title="D√©placer">‚ò∞</span>
				<!-- Ligne titre + ic√¥nes de priorit√© + badge d'√©ch√©ance align√© √† droite -->
				<div class="title-row">
					<!-- Gauche : titre + üî•‚≠ê -->
					<div class="title-text font-medium flex items-center gap-2">
						{{ t.title }}
						<span class="flex items-center gap-1">
							{% if t.urgent %}
							<span class="prio-icon prio-urgent" title="Urgent">üî•</span>
							{% endif %}
							{% if t.important %}
							<span class="prio-icon prio-important" title="Important">‚≠ê</span>
							{% endif %}
							{% if not t.urgent and not t.important %}
							<span class="prio-none">‚Ä¢</span>
							{% endif %}
						</span>
					</div>

					<!-- Droite : badge d'√©ch√©ance -->
					<div class="flex items-center gap-1">
						{% if t.due_status == 'overdue' %}
						<span class="badge badge-due-overdue" title="En retard">Retard</span>
						{% elif t.due_status == 'today' %}
						<span class="badge badge-due-today" title="√âch√©ance aujourd'hui">Auj.</span>
						{% elif t.due_status == 'soon' %}
						<span class="badge badge-due-soon" title="√âch√©ance cette semaine">7 j</span>
						{% endif %}
					</div>
				</div>

				<!-- Ligne infos : date + statut -->
				<div class="text-xs text-slate-500 flex items-center gap-2 mt-1">
					{% if t.due_date %}
					<span class="inline-flex items-center gap-1">
						<span>üìÖ</span> <span>{{ t.due_date }}</span>
					</span>
					{% else %}
					<span>Sans √©ch√©ance</span>
					{% endif %}
					{% if t.status == "done" %}
					<span class="badge badge-done">Fait</span>
					{% endif %}
				</div>
			</li>
			{% endfor %}
		</ul>
		{% endif %}
	</div>

	<div class="card">
		<div class="font-semibold mb-2">Q3 ‚Äì D√©l√©guer</div>
		{% if q3|length == 0 %}
		<div class="text-xs text-slate-400">Rien pour l‚Äôinstant.</div>
		{% else %}
		<ul class="space-y-2 text-sm">
			{% for t in q3 %}
			<li data-task-id="{{ t.id }}" class="border-b border-slate-200/40 pb-2 last:border-b-0">
				<span class="drag-handle" title="D√©placer">‚ò∞</span>
				<!-- Ligne titre + ic√¥nes de priorit√© + badge d'√©ch√©ance align√© √† droite -->
				<div class="title-row">
					<!-- Gauche : titre + üî•‚≠ê -->
					<div class="title-text font-medium flex items-center gap-2">
						{{ t.title }}
						<span class="flex items-center gap-1">
							{% if t.urgent %}
							<span class="prio-icon prio-urgent" title="Urgent">üî•</span>
							{% endif %}
							{% if t.important %}
							<span class="prio-icon prio-important" title="Important">‚≠ê</span>
							{% endif %}
							{% if not t.urgent and not t.important %}
							<span class="prio-none">‚Ä¢</span>
							{% endif %}
						</span>
					</div>

					<!-- Droite : badge d'√©ch√©ance -->
					<div class="flex items-center gap-1">
						{% if t.due_status == 'overdue' %}
						<span class="badge badge-due-overdue" title="En retard">Retard</span>
						{% elif t.due_status == 'today' %}
						<span class="badge badge-due-today" title="√âch√©ance aujourd'hui">Auj.</span>
						{% elif t.due_status == 'soon' %}
						<span class="badge badge-due-soon" title="√âch√©ance cette semaine">7 j</span>
						{% endif %}
					</div>
				</div>

				<!-- Ligne infos : date + statut -->
				<div class="text-xs text-slate-500 flex items-center gap-2 mt-1">
					{% if t.due_date %}
					<span class="inline-flex items-center gap-1">
						<span>üìÖ</span> <span>{{ t.due_date }}</span>
					</span>
					{% else %}
					<span>Sans √©ch√©ance</span>
					{% endif %}
					{% if t.status == "done" %}
					<span class="badge badge-done">Fait</span>
					{% endif %}
				</div>
			</li>
			{% endfor %}
		</ul>
		{% endif %}
	</div>

	<div class="card">
		<div class="font-semibold mb-2">Q4 ‚Äì √âliminer</div>
		{% if q4|length == 0 %}
		<div class="text-xs text-slate-400">Rien pour l‚Äôinstant.</div>
		{% else %}
		<ul class="space-y-2 text-sm">
			{% for t in q4 %}
			<li data-task-id="{{ t.id }}" class="border-b border-slate-200/40 pb-2 last:border-b-0">
				<span class="drag-handle" title="D√©placer">‚ò∞</span>
				<!-- Ligne titre + ic√¥nes de priorit√© + badge d'√©ch√©ance align√© √† droite -->
				<div class="title-row">
					<!-- Gauche : titre + üî•‚≠ê -->
					<div class="title-text font-medium flex items-center gap-2">
						{{ t.title }}
						<span class="flex items-center gap-1">
							{% if t.urgent %}
							<span class="prio-icon prio-urgent" title="Urgent">üî•</span>
							{% endif %}
							{% if t.important %}
							<span class="prio-icon prio-important" title="Important">‚≠ê</span>
							{% endif %}
							{% if not t.urgent and not t.important %}
							<span class="prio-none">‚Ä¢</span>
							{% endif %}
						</span>
					</div>

					<!-- Droite : badge d'√©ch√©ance -->
					<div class="flex items-center gap-1">
						{% if t.due_status == 'overdue' %}
						<span class="badge badge-due-overdue" title="En retard">Retard</span>
						{% elif t.due_status == 'today' %}
						<span class="badge badge-due-today" title="√âch√©ance aujourd'hui">Auj.</span>
						{% elif t.due_status == 'soon' %}
						<span class="badge badge-due-soon" title="√âch√©ance cette semaine">7 j</span>
						{% endif %}
					</div>
				</div>

				<!-- Ligne infos : date + statut -->
				<div class="text-xs text-slate-500 flex items-center gap-2 mt-1">
					{% if t.due_date %}
					<span class="inline-flex items-center gap-1">
						<span>üìÖ</span> <span>{{ t.due_date }}</span>
					</span>
					{% else %}
					<span>Sans √©ch√©ance</span>
					{% endif %}
					{% if t.status == "done" %}
					<span class="badge badge-done">Fait</span>
					{% endif %}
				</div>
			</li>
			{% endfor %}
		</ul>
		{% endif %}
	</div>

</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<style>
	/* indicate draggable items in the matrix */
	.card ul li {
		cursor: grab;
		-webkit-user-select: none;
		-ms-user-select: none;
		user-select: none;
	}

	.card ul li:active {
		cursor: grabbing;
	}

	.drag-handle {
		cursor: grab;
		display: inline-block;
		width: 20px;
		text-align: center;
		margin-right: 8px;
		color: #888;
		user-select: none;
	}

	.drag-handle:active {
		cursor: grabbing;
	}
</style>
<script>
	document.addEventListener('DOMContentLoaded', function () {
		// Find all quadrant lists (the <ul> elements inside each card)
		const lists = Array.from(document.querySelectorAll('.card ul'));
		if (!lists.length || typeof Sortable === 'undefined') return;

		// Helper to update positions of items inside a list (1-based)
		async function updatePositionsInList(listEl) {
			const items = Array.from(listEl.querySelectorAll('li'));
			let pos = 1;
			const promises = [];
			for (const it of items) {
				const id = it.dataset.taskId;
				if (!id) continue;
				promises.push(fetch(`/api/tasks/${id}/position`, {
					method: 'PATCH', headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify({ position: pos })
				}));
				pos++;
			}
			try { await Promise.all(promises); } catch (e) { console.error('Position update error', e); }
		}

		lists.forEach((ul, idx) => {
			Sortable.create(ul, {
				onStart: function () { document.body.style.userSelect = 'none'; },
				handle: '.drag-handle',
				group: 'matrix',
				animation: 150,
				onAdd: async function (evt) {
					// When item is moved into this list, update quadrant then positions
					const item = evt.item;
					const id = item.dataset.taskId;
					const target = evt.to;
					// Quadrant number mapping based on column index (q1..q4)
					// We rely on the ordering of lists in the template: q1,q2,q3,q4
					const quadrantIndex = lists.indexOf(target);
					const quadrantNumber = quadrantIndex + 1;

					try {
						await fetch(`/api/tasks/${id}/quadrant`, {
							method: 'PATCH', headers: { 'Content-Type': 'application/json' },
							body: JSON.stringify({ quadrant: quadrantNumber })
						});
					} catch (e) {
						console.error('Failed to update quadrant', e);
					}

					// Recalculate positions within target list and source list using bulk endpoint
					const targetItems = Array.from(target.querySelectorAll('li')).map((it, i) => ({ id: Number(it.dataset.taskId), position: i + 1 }));
					const fromItems = evt.from ? Array.from(evt.from.querySelectorAll('li')).map((it, i) => ({ id: Number(it.dataset.taskId), position: i + 1 })) : [];

					try {
						if (targetItems.length) await fetch('/api/tasks/reorder', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ items: targetItems }) });
						if (fromItems.length) await fetch('/api/tasks/reorder', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ items: fromItems }) });
					} catch (e) {
						console.error('Failed to bulk update positions after move', e);
					}
				},
				onUpdate: async function (evt) {
					// Reordering within same quadrant: update positions
					const listEl = evt.from;
					await updatePositionsInList(listEl);
				}
				, onEnd: function () { document.body.style.userSelect = ''; }
			});
		});
	});
</script>
{% endblock %}
